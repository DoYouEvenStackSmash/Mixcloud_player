<script>
	// This is designed to play specific songs from mixcloud...
	// I know i overuse loops and i should just be using indexes of the PLAYLIST_SONGS as keys, but i have future plans that might not allow that to be used.

	var PLAYER_HISTORY_STACK = [];
	var TIMESTAMPS = {};
	var PLAYLIST_SONGS = [];
	async function update_playlist_songs() {
		// custom func for filling PLAYLIST_SONGS with whatever you want
		
		// my func will do Podcasts #600+ RONS and 382
		const ronsreg = /RONS.*?Podcast.*?([6]\d{2}|\d{4,})/i;
		var search_queue = ["https://api.mixcloud.com/search/?limit=100&q=rons%20podcast%20%236&type=cloudcast"];
		while (search_queue.length > 0) {
			var search_url = search_queue.pop();
			var search_results = await get_JSON(search_url);
			if ('data' in search_results) {
				for (var i in search_results['data']) {
					let m;
					if ((m = ronsreg.exec(search_results['data'][i]['name'])) !== null) {
						PLAYLIST_SONGS.push({
							name:search_results['data'][i]['name'],
							key:search_results['data'][i]['key']
							});
					}
					
				}
			}
			if ('paging' in search_results) {
				if ('next' in search_results['paging']) {
					search_queue.push(search_results['paging']['next'])
				}
			}
		}

		// REMOVE BAD SONGS
		var BAD_SONGS = ['/therealrons/rons-podcast-529/','RONS Podcast #160']; 	// EXAMPLE VALUES, EDIT THIS AS WE SEE FIT
		
		var i = PLAYLIST_SONGS.length - 1;
		while (i >= 0) {
			if (PLAYLIST_SONGS[i].name in BAD_SONGS || PLAYLIST_SONGS[i].key in BAD_SONGS) {
				PLAYLIST_SONGS = PLAYLIST_SONGS.splice(i, 1);
			} 
			i -= 1;
		}

		// TODO: GET AUDIO KEYS FOR EACH ITEM WHEN?
		console.log('done upadting my song playlist');
		return true;
	}

	async function get_JSON(url) { let response = await fetch(url); let data = await response.json(); return data; }
	
	// this was working at one point, then they implemented cors issues so i had to go thru justcors.com
	async function retreive_audio_src2(key) { return JSON.parse(await (await fetch(`https://www.dlmixcloud.com/ajax.php/?url=https://www.mixcloud.com${key}`,{mode: 'no-cors'})).text())['url']; }

	async function retreive_audio_src(key) { 
		var url = `https://justcors.com/l_n1ehx3zipc/https://www.dlmixcloud.com/ajax.php/?url=https://www.mixcloud.com${key}`;
		var response = await fetch(url)
		var result_text = await response.text()
		var resulting_json = JSON.parse(result_text)
		var value = resulting_json['url'];
		return value;
	}

	function get_random_song_idx(){
		// Loads a random song index from the playlist queue, tries to not replay the last DONT_REPLAY_FROM_THE_LAST_X_SONGS songs.
		const DONT_REPLAY_FROM_THE_LAST_X_SONGS = 5;
		var r = Math.floor(Math.random() * PLAYLIST_SONGS.length);
		if (PLAYER_HISTORY_STACK.length < DONT_REPLAY_FROM_THE_LAST_X_SONGS) {
			// no option to play a diff song.
			return r;
		}
		while (r in PLAYER_HISTORY_STACK.slice(-DONT_REPLAY_FROM_THE_LAST_X_SONGS)) {
			r = Math.floor(Math.random() * PLAYLIST_SONGS.length);
		}
		return r;
	}
	function get_next_song_idx(){
		// Loads up the next song from the playlist queue.
		if (PLAYER_HISTORY_STACK.length == 0) {
			// no option to play a diff song.
			return 0;
		}
		return (PLAYER_HISTORY_STACK[0] + 1) % PLAYLIST_SONGS.length;
	}
	function mark_favorited_timestamp(){
		// adds a way to mark down timestamps of specific songs so that we can keep track of favorite songs etc.
		if (!('timestamps' in PLAYLIST_SONGS[PLAYER_HISTORY_STACK[0]])) {
			PLAYLIST_SONGS[PLAYER_HISTORY_STACK[0]].timestamps = [];
		}
		var curr_timestamp = 0;	// TODO: GET CURRENT TIMESTAMP
		if (!(curr_timestamp in PLAYLIST_SONGS[PLAYER_HISTORY_STACK[0]].timestamps)){
			PLAYLIST_SONGS[PLAYER_HISTORY_STACK[0]].timestamps.push(curr_timestamp);
		}
	}

	function load_selected_song(){
		var selected_val = document.querySelector('select').value;
		var i = 0;
		while (i < PLAYLIST_SONGS.length) {
			if (PLAYLIST_SONGS[i].key == selected_val) {
				load_next_song(i);
				return;
			}
			++i;
		}
	}
	/**
	 * PREREQ: update_playlist_songs has been run
	 * @param next_song, <int> the index from the PLAYLIST_SONGS to use, <null>=0, <str> the song key from the PLAYLIST_SONGS to use.
	 */
	async function load_next_song(next_song=null){
		// is run when we want to start loading a new song into the player
		if (typeof(next_song) == 'number') {
			next_song = (parseInt(next_song) || 0) % PLAYLIST_SONGS.length;
		} else if (typeof(next_song) == 'string') {
			var s = next_song;
			next_song = 0;
			while (next_song < PLAYLIST_SONGS.length) {
				if (PLAYLIST_SONGS[next_song].name == s || PLAYLIST_SONGS[next_song].key == s) {
					break
				}
				++next_song;
			}
			if (next_song == PLAYLIST_SONGS.length) {
				next_song = get_random_song_idx();
			}
		} else {
			next_song = get_next_song_idx();
		}
		// now next_song is an int.
		if (PLAYLIST_SONGS[next_song].src == undefined) {
			PLAYLIST_SONGS[next_song].src = await retreive_audio_src(PLAYLIST_SONGS[next_song].key);
		}
		// now we have the src for this song... its ready to be loaded
		await update_player_src(PLAYLIST_SONGS[next_song].src);

		// set currently playing in player history
		PLAYER_HISTORY_STACK.splice(0, 0, next_song);
	}

	/**
	 * @param src: <str> the audio source string to be played
	 */
	async function update_player_src(src) {
		// TODO update our players src
		var video = document.querySelector('video');
		var source = document.querySelector('source');
		if (!source) { source = document.createElement('source'); }
		source.setAttribute('src', src);
		video.load();
		try{video.play();}catch{}
	}

	function update_dropdown_with_current_songs(){
		var i = 0;
		var dropdown_selections = document.getElementById('songlist_selector').options;
		while (i < PLAYLIST_SONGS.length) {
			dropdown_selections.add(new Option(PLAYLIST_SONGS[i].name,PLAYLIST_SONGS[i].key));
			++i;
		}
	}

	window.onload = async function() {
		await update_playlist_songs();
		update_dropdown_with_current_songs();
		load_next_song();
	};
</script>
<body>
	<h4>
		Currently playing:&nbsp;<select id="songlist_selector" onchange="load_selected_song()"></select>
		&nbsp;<button id="skip" onclick="load_next_song(get_next_song_idx())">skip this song</button>
		&nbsp;<button id="random_button" onclick="load_next_song(get_random_song_idx())">chose a random song</button>
		&nbsp;<button id="mark_timestamp" onclick="mark_favorited_timestamp()">mark current timestamp</button>
	</h4>
	<video controls autoplay id="player"><source src="" type="audio/mp4" id="player_source"></video>
	<h4>Played history:</h4>
	<ul id="played_history_list">todo: implement this bit</ul>
	<p>TIMESTAMPS:</p>
	<ul id="timestamps_list">todo: implement this bit</ul>
</body>
